<!-- /home/lenovo/code/ltphongssvn/node-js-design-patterns-fourth-edition/views/dashboard.ejs -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NYC Taxi KPI Dashboard</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>NYC Taxi Company KPIs</h1>
      <p class="subtitle">Batch Data Pipeline - Spark Project Dashboard</p>
    </header>
    
    <section class="summary">
      <h2>City Planners KPIs</h2>
      <div class="kpi-grid">
        <div class="kpi-card">
          <h3>Peak-Hour Trip %</h3>
          <p class="kpi-value"><%= data.summary.peakHourTripPct?.toFixed(1) || '0.0' %>%</p>
          <p class="kpi-desc">7-9 AM / 5-7 PM</p>
        </div>
        <div class="kpi-card">
          <h3>Avg Trip Time vs Distance</h3>
          <p class="kpi-value"><%= data.summary.avgMinutesPerMile?.toFixed(1) || '0.0' %> min/mi</p>
          <p class="kpi-desc">Minutes per mile</p>
        </div>
      </div>
    </section>

    <section class="summary">
      <h2>Fleet Operators KPIs</h2>
      <div class="kpi-grid">
        <div class="kpi-card">
          <h3>Total Trips</h3>
          <p class="kpi-value"><%= data.summary.totalTrips?.toLocaleString() || '0' %></p>
          <p class="kpi-desc">All weeks</p>
        </div>
        <div class="kpi-card">
          <h3>Total Revenue</h3>
          <p class="kpi-value">$<%= data.summary.totalRevenue?.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}) || '0.00' %></p>
          <p class="kpi-desc">All weeks</p>
        </div>
        <div class="kpi-card">
          <h3>Avg Revenue per Mile</h3>
          <p class="kpi-value">$<%= data.summary.avgRevenuePerMile?.toFixed(2) || '0.00' %></p>
          <p class="kpi-desc">Per mile</p>
        </div>
        <div class="kpi-card">
          <h3>Night Trip %</h3>
          <p class="kpi-value"><%= data.summary.nightTripPct?.toFixed(1) || '0.0' %>%</p>
          <p class="kpi-desc">10 PM - 6 AM</p>
        </div>
      </div>
    </section>

    <section class="chart-section">
      <h2>KPI 1: Weekly Trip Volume by Borough (City Planners)</h2>
      <div style="position: relative; height: 400px;">
        <canvas id="myChart"></canvas>
      </div>
    </section>

    <section class="data-table">
      <h2>Trip Volume Details</h2>
      <table>
        <thead>
          <tr>
            <th>Week Start</th>
            <th>Borough</th>
            <th>Trip Volume</th>
          </tr>
        </thead>
        <tbody>
          <% data.weeklyByBorough.forEach(row => { %>
          <tr>
            <td><%= row.weekStart %></td>
            <td><%= row.borough %></td>
            <td><%= row.tripVolume.toLocaleString() %></td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </section>
  </div>

  <script>
    const ctx = document.getElementById('myChart');
    const chartData = <%- JSON.stringify(data.weeklyByBorough) %>;
    
    // Group data by week and borough
    const weeks = [...new Set(chartData.map(d => d.weekStart))].sort();
    const boroughs = [...new Set(chartData.map(d => d.borough))];
    
    // Create datasets
    const datasets = boroughs.map((borough, i) => {
      const color = `hsl(${i * 45}, 70%, 50%)`;
      return {
        label: borough,
        data: weeks.map(week => {
          const item = chartData.find(d => d.borough === borough && d.weekStart === week);
          return item ? item.tripVolume : 0;
        }),
        backgroundColor: color,
        borderColor: color,
        borderWidth: 1
      };
    });
    
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: weeks,
        datasets: datasets
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  </script>
</body>
</html>
